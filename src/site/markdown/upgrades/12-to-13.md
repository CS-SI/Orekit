<!--- Copyright 2002-2024 Thales Alenia Space
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

# Upgrading from Orekit 12.X to Orekit 13.0

Version 13.0 of Orekit introduced some incompatible API changes with respect
to versions 12.x. These changes are summarized in the following table. The next
paragraphs give hints about what should be changed in application source code to
adapt to this new version.

| change                                                                                                                                                                    | related issue                                                 |
|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|
| [measurement generation returns EstimatedMeasurementBase](#Measurement_generation_now_returns_EstimatedMeasurementBase)                                                   | [issue 1350](https://gitlab.orekit.org/orekit/-/issues/1350/) |
| [Frequency replaced by RadioWave, GnssSignal, or PredefinedGnssSignal where relevant](#Frequency_replaced_by_RadioWave_GnssSignal_or_PredefinedGnssSignal_where_relevant) | [issue 1434](https://gitlab.orekit.org/orekit/-/issues/1434/) |
| [position angles conversions moved](#Position_angles_conversions_moved)                                                                                                   | [issue 1275](https://gitlab.orekit.org/orekit/-/issues/1275/) |
| [building an AbsoluteDate from Instant is always in UTC time scale](#Building_an_AbsoluteDate_from_Instant_is_always_in_UTC_time_scale)                                   | [issue 1272](https://gitlab.orekit.org/orekit/-/issues/1272/) |

## Measurement generation now returns EstimatedMeasurementBase

### overview of the change
Up to version 12.X, the `build` method in `MeasurementBuilder<T>` interface from
package `org.orekit.estimation.measurements.generation` did return an
object of type `T`, where `T` was the parameterized type in `MeasurementBuilder<T>`
and extended `ObservedMeasurement<T>`.

Returning only the observed value was limiting as users may sometimes need
access to the complete states that were used during the generation. These states
were in fact computed internally and discarded after the observed measurement
was produced. The rationale of this change was to allow retrieving these
complete states.

Starting with version 13.0 the return type of the `build` method was therefore
changed to `EstimatedMeasurementBase<T>`.

### how to adapt existing source code

If the additional information is relevant to the caller application, then users
should change the type of the variable they use to store the estimated measurement
and use it. This means replacing
```java
final T built = builder.build(date, interpolators);
```
by
```java
final EstimatedMeasurementBase<T> built = builder.build(date, interpolators);
```

If the additional information is not relevant to the caller application, then users
can just extract the observed measurement from the estimated measurement.
This means replacing
```java
final T built = builder.build(date, interpolators);
```
by
```java
final T built = builder.build(date, interpolators).getObservedMeasurement();
```

## Frequency replaced by RadioWave, GnssSignal, or PredefinedGnssSignal where relevant

### overview of the change
Up to version 12.X, numerous classes and methods in the library used the
enumerate `Frequency` from package `org.orekit.gnss` directly. This enumerate
lists the predefined frequencies that are used by the existing GNSS systems
(GPS, Glonass, Galileo, Beidou, QZSS, IRNSS, SBAS).

An enumerate is fine when dealing with existing systems supported by Orekit,
but it is not sufficient when designing new navigation systems using new
frequencies or new names. The rationale of this change was to allow using
custom frequencies. The naming convention was also awkward as the name
`Frequency` was too generic and therefore confusing and as the API also
provided access to other elements (like wavelength, common predefinedGnssSignal
multiplier, and name). A last problem with the enumerate API was that it
used non-SI units (MHz instead of Hz for predefinedGnssSignal).

This change was introduced in two steps, one that did not break the API
and was introduced in version 12.1 and one that did break the API and was
introduced in version 13.0.

Starting with version 12.1, several methods of this enumerate where moved
upward in new interface `GnssSignal` and its superinterface `RadioWave`.
This had no consequence on users source code. Starting with version 13.0,
the `Frequency` enumerate was renamed `PredefinedGnssSignal` and numerous
methods that did reference were changed to reference either `RadioWave`,
`GnssSignal`, or `PredefinedGnssSignal`.

As long as only an enumerate was used, relying on the equality operator `==`
to compare a predefined signal with a reference was relevant. It is not relevant
anymore when using interfaces implemented by custom user classes. Two
predicate methods, `closeTo(other)` and `closeTo(other, tolerance)` have
therefore been added to check if frequencies are close enough. The first
method uses a default tolerance of 1 mHz, which is enough for most purposes.

A few method names have been changed according to their return types,
for example `getFrequencies()` in `Antenna` has been renamed `getRadioWaves()`
and `getSignal()` in `BeidouCivilianNavigationMessage` has been renamed
`getRadioWave()`.

### how to adapt existing source code

In most cases, as the interfaces are just higher level abstractions of the
same concept that was already implemented by the `Frequency` enumerate,
users can just change the types of the objects they use to either
`PredefinedGnssSignal`, `GnssSignal` or `RadioWave` depending on the method.
Sometimes the type appears in a parameterized type, so for example the
`ReceiverAntenna` constructor now requires a `Map<RadioWave, FrequencyPattern>`
instead of a `Map<Frequency, FrequencyPattern>`. Such types changes in methods
signatures and field types are sufficient if the only methods used in the
enumerate were `getName()` or `getRatio()` (which are defined in `GnssSignal`)
or if they were `getFrequency()` or `getWavelength()` (which are defined in
`RadioWave`). Note that `getMHzFrequency()` has been replaced by `getFrequency()`
which returns a predefinedGnssSignal in Hz and not in MHz anymore, for consistency with
Orekit convention to use SI units everywhere.

As explained above, if the enumerate was used directly with an equality
operator to check against some predefined value, this check should be
changed to a proximity check by calling one of the `closeTo` methods.

The call sites for methods that have changed names must be adapted to use
the new names.

## Position angles conversions moved

### overview of the change
Up to version 12.X, position angles in orbits (anomalies for `{Field}KeplerianOrbit`,
latitude arguments for `{Field}CircularOrbit`, longitude arguments for
`{Field}EquinoctialOrbit`) could be converted between their `MEAN`, `TRUE` and
`ECCENTRIC` flavors using static methods in the orbit classes themselves. These static
have been moved to dedicated utility classes `{Field}KeplerianAnomalyUtility`,
`{Field}CircularAnomalyUtility`, and `{Field}EquinoctialAnomalyUtility` as of version
12.1. The methods in the orbit classes have been deprecated in 12.1 and removed
in 13.0.

### how to adapt existing source code

As the methods are static ones, just the name of the class providing the
methods should be changed. This means replacing (taking circular orbit
and conversion from `ECCENTRIC` to `TRUE` as an example):
```java
final double alphaV = CircularOrbit.eccentricToTrue(ex, ey, alphaE);
```
by
```java
final double alphaV = CircularLatitudeArgumentUtility.eccentricToTrue(ex, ey, alphaE);
```

## Building an AbsoluteDate from Instant is always in UTC time scale

### overview of the change
In the 12.X series, it was possible to build an `AbsoluteDate` from a
`java.time.Instant`, specifying an arbitrary time scale. This was not
compliant with the `Instant` API which requires using UTC. A constructor
using only the `Instant` was added in 12.1 as well as a constructor with
at time scale that is enforced to be UTC. The constructor with
`Instant` and `TimeScale` was deprecated. The deprecated constructor
was removed in 13.0.

### how to adapt existing source code

If the constructor with a `Instant` and `TimeScale` was used and the
time scale was already UTC, then there is nothing to do. If the time
scale was not UTC, then the semantics must be revised by users, as they
did violate `Instant` API, so they probably need to check how the
`Instant` is produced, to ensure it is really in UTC.
